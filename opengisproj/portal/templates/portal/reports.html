{% extends 'portal/base.html' %}
{% block title %}Reports{% endblock %}

{% block content %}
        <div class="row width-100-p no-margin">
            <section class="pull-left height-100 col-md-3 overflow-scroll">
                <div class="text-center alert"  id="gisDataTableError"></div>
                <table id="gisDataTable"></table>
            </section>
            <section class="pull-left height-100 col-md-9 no-padding">
                <div class="container height-inherit no-margin no-padding width-100-p">
                    <div id="gisMap" class="height-inherit"></div>
                </div>
            </section>
        </div>
        <div class="modal fade" tabindex="-1" role="dialog" id="gisModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Test Title</h4>
                    </div>
                    <div class="modal-body">
                        Test content
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block js %}
<script>
    var map;
    var mapsContainer = $("#gisMap")[0];
    var cent_lat = 28.644800; //Delhi 
    var cent_long = 77.216721; //Delhi
    var data_cache;
    function get_curr_cord(){
        if(navigator.geolocation){
            navigator.geolocation.getCurrentPosition(storePos);
        }
    }
    function storePos(position){
        cent_lat = position.coords.latitude;
        cent_long = position.coords.longitude;
        var api_checker = setInterval(function(){if(api_loaded){showMap();clearInterval(api_checker);}},500);
    }
    function initMap(){
        api_loaded = true;
    }
    function showMap(){
        map = new google.maps.Map(mapsContainer, {
            center: {lat: cent_lat, lng: cent_long },
            zoom: 6
        });
        getGisData(loadGisDataToMap);
    }
    function loadGisDataToMap(data){
        $.each(data, function(i,v){
            console.log(v);
            var coord = {lat: parseFloat(v.latitude) , lng: parseFloat(v.longitude) };
            var marker = new google.maps.Marker({
                position: coord,
                map: map,
                title: v.sample_identifier,
                label: v.id
            });
            marker.addListener('click', function() {
                showGisDetails(v.id);
            });
        });
        data_cache = data;
    }
    function showGisDetails(id){
        var gisModal = $("#gisModal");
        $.each(data_cache, function(i,v){
            if(parseInt(v.id) == parseInt(id)){
                gisModal.find(".modal-title").html(v.sample_identifier);
                var html = "Dumping Raw Data<br>";
                $.each(v, function(index,value){
                    html += "<br>"+index+":"+value;
                });
                gisModal.find(".modal-body").html(html);
                return false;
            }
        });
        gisModal.modal();
    }
    get_curr_cord();
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD2DVlvcLu7o2m-6OhfbipppHEzRofJh48&callback=initMap"></script>
{% include 'portal/partials/gistable.html' %}
{% endblock %}