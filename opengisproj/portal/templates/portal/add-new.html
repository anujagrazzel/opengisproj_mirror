{% extends 'portal/base.html' %}
{% load static %}

{% block title %}Add Data{% endblock %}

{% block content %}
    <div class="row width-inherit">
        <div class="col-xs-12">
            <h3 class="text-center">Add New GIS Data</h3>
        </div>
        <div class="row">
            <div class="container">
                <div class="col-xs-12">
                    <form id="addNewDataForm">
                        {% csrf_token %}
                    </form> 
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script src="{% static 'portal/js/chance.min.js' %}"></script>
    <script>
        $(document).ready(function(e){
            var form = $("#addNewDataForm");
            var apiURI = '/portal/ajax/';
            var submitBtn = '<button type="submit" id="addNewDataBtn" class="btn btn-default">Add</button>';
            var data_groups;
            var groupSelectHtml = '<div class="form-group"><label for="dataGroupSelect">Group</label><select id="dataGroupSelect" name="data_group" class="form-control dataGroupContainer" required></select></div>'
            /*
            var rand_count = 0;
            var chance = new Chance(Math.random()); */
            function init(){
                getmetafields(generateForm);
                getDataGroups(storeGroups);
            }
            function storeGroups(data){
                data_groups = data;
                updateGroupContainers();
            }
            function updateGroupContainers(){
                $.each(data_groups, function(i,v){
                    $(".dataGroupContainer").append('<option value="'+v.id+'">'+v.name+'</option>');
                });
                
            }
            function generateForm(response){
                $.each(response, function(i,v){
                    var html = '<div class="form-group"><label for="key_'+v.key_name+'">'+v.label+'</label><input class="form-control" type="'+v.key_type+'" data-non-meta="'+v.non_meta+'"data-key="'+v.key_name+'" id="key_'+v.key_name+'" name="'+v.key_name+'"';
                    if(v.min!="Null" && v.min!="undefined")
                        html+=' min="'+v.min+'"';
                    if(v.max!="Null" && v.max!="undefined")
                        html+=' max="'+v.max+'"';
                    if(v.step!="Null" && v.step!="undefined")
                        html+=' step="'+v.step+'"';
                    if(v.max_len!="Null" && v.max_len!="undefined")
                        html+=' max-len="'+v.max_len+'"';
                    if(v.required!="Null" && v.required!=undefined && v.required!="undefined" && v.required=="True") 
                        html+=' required';
                    html+='></div>';
                    addToForm(html);
                });
                addToForm(groupSelectHtml);
                form.find("input").change(function(){
                    validateField($(this));
                }); 
                addToForm(submitBtn);
                submitBtn = $("#addNewDataBtn");
                //setTimeout(function(){addRandomData();},2000);
            }

            function addToForm(html){
                form.append(html);
            }
            function validateForm(){
                var toReturn = false;
                form.find("input,select").each(function(e){
                    toReturn = validateField($(this));
                    if(!toReturn)
                        return false;
                });
                return toReturn;
            }
            
            form.submit(function(e){
                e.preventDefault();
                if(!validateForm())
                    return false;
                var data = form.serialize();
                submitBtn.html("Processing");
                $.ajax({
                    url: apiURI + "addNewData",
                    type: "POST",
                    data: data,
                    dataType: "JSON",
                    success: function(response){
                        r = response;
                        processResponse(r);
                    },
                    error: function(response){
                        console.log("Error");
                        console.log(response);
                    }
                });
                function processResponse(r){
                    if(r.status=="success"){
                        submitBtn.html("Added Successfully");
                        setTimeout(function(){resetForm();}, 1000);
                    }
                }
            });
            function resetForm(){
                form[0].reset();
                submitBtn.html("Add");
                /*
                rand_count = rand_count+1;
                addRandomData(true);*/
            }
            /*
            function addRandomData(cont=false){
                if(!cont){
                    var conf = confirm("Add 5000 entries?");
                    if(!conf)
                        return false;
                    rand_count = 0;
                }
                if(rand_count>=2000)
                    return false;
                console.log("Adding Entry #"+rand_count);
                if(fillRandomData()){
                    console.log($("#addNewDataForm").serialize());
                    $("#addNewDataForm").submit();
                }
            }
            function fillRandomData(){
                $("#addNewDataForm input").each(function(){
                        if($(this).attr("data-key")!="undefined" || $(this).attr("data-key")!=undefined){
                            var key = $(this).attr("data-key");
                            if(key == "latitude"){
                                $(this).val(chance.latitude());
                            }
                            else if(key == "longitude"){
                                $(this).val(chance.longitude());
                            }
                            else if(key == "ph"){
                                $(this).val(chance.floating({min:1, max:13, fixed:2}));
                            }
                            else if(key == "year"){
                                $(this).val(parseInt(chance.year({min:1947, max: 2100})));
                            }
                            else if(key == "tds"){
                                $(this).val(chance.floating({max:1000, min:0, fixed:3}));
                            }
                            else if(key == "sample_identifier"){
                                $(this).val(chance.word());
                            }
                            else if(key == "temperature"){
                                $(this).val(chance.floating({max:100, min:-50, fixed:2}));
                            }
                        }
                });
                return true;
            }*/
            init();
        });
    </script>
{% endblock %}